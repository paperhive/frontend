<div class="container">
  <form novalidate ng-submit="$ctrl.submitQuery()" class="ph-xl-margin-top">
    <div class="form-group">
      <div class="input-group input-group-lg">
        <input
          ng-model="$ctrl.queryModel"
          class="form-control"
          placeholder="Search documents"
        >
        <span class="input-group-btn">
          <button class="btn btn-default" type="submit">
            <i class="fa fa-fw fa-search"></i>
          </button>
        </span>
      </div>
      <small class="help-block">
        <i class="fa fa-fw fa-info-circle"></i>
        Search
        <i ng-if="$ctrl.totalUpdating" class="fa fa-circle-o-notch fa-spin"></i>
        <span ng-if="!$ctrl.totalUpdating">{{$ctrl.total | number}}</span>
        documents by title, author, DOI or arxiv id.
      </small>
    </div>
  </form>
  <p>
    <dropdown-select
      icon-classes="fa fa-fw fa-sort-amount-asc"
      description="$ctrl.searchFetchCtrls.sortBy.selectedItem.label"
      items="$ctrl.searchFetchCtrls.sortBy.items"
      on-select="$ctrl.searchFetchCtrls.sortBy.select(item)"
    ></dropdown-select>
  </p>
</div>
<div class="ph-search-filters">
  <div class="container">
    <div class="row">
      <div class="col-md-3 text-center">
        <h5>Publication date</h5>
        <search-date aggregation="$ctrl.filters.publishedAt.aggregation"></search-date>
        <a href class="small ph-link-icon"
          ng-click="$ctrl.filterCtrls.publishedAt.update({})"
          ng-class="{'ph-hidden': !$ctrl.filterCtrls.publishedAt.mode}"
        >
          <i class="fa fa-fw fa-times"></i>
          Clear filter
        </a>
        <search-date-dropdown
          aggregation="$ctrl.filters.publishedAt.aggregation"
          filter="$ctrl.filterCtrls.publishedAt"
          on-filter-update="$ctrl.filterCtrls.publishedAt.update({mode, from, to})"
        ></search-date-dropdown>
      </div>
      <div class="col-md-3 text-center">
        <h5>Document type</h5>
        <search-donut
          aggregation="$ctrl.filters.documentType.aggregation"
          selected="$ctrl.filterCtrls.documentType.terms"
          on-add="$ctrl.filterCtrls.documentType.add(term)"
          on-remove="$ctrl.filterCtrls.documentType.remove(term)"
        ></search-donut>
        <a href class="small ph-link-icon"
          ng-click="$ctrl.filterCtrls.documentType.reset()"
          ng-class="{'ph-hidden': !$ctrl.filterCtrls.documentType.isActive()}"
        >
          <i class="fa fa-fw fa-times"></i>
          Clear filter
        </a>
        <search-dropdown
          description="Filter by document type"
          aggregation="$ctrl.filters.documentType.aggregation"
          selected="$ctrl.filterCtrls.documentType.terms"
          on-add="$ctrl.filterCtrls.documentType.add(term)"
          on-remove="$ctrl.filterCtrls.documentType.remove(term)"
        ></search-dropdown>
      </div>
      <div class="col-md-3 text-center">
        <h5>Journal</h5>
        <search-donut
          aggregation="$ctrl.filters.journal.aggregation"
          selected="$ctrl.filterCtrls.journal.terms"
          on-add="$ctrl.filterCtrls.journal.add(term)"
          on-remove="$ctrl.filterCtrls.journal.remove(term)"
        ></search-donut>
        <a href class="small ph-link-icon"
          ng-click="$ctrl.filterCtrls.journal.reset()"
          ng-class="{'ph-hidden': !$ctrl.filterCtrls.journal.isActive()}"
        >
          <i class="fa fa-fw fa-times"></i>
          Clear filter
        </a>
        <search-dropdown
          description="Filter by journal"
          aggregation="$ctrl.filters.journal.aggregation"
          selected="$ctrl.filterCtrls.journal.terms"
          on-add="$ctrl.filterCtrls.journal.add(term)"
          on-remove="$ctrl.filterCtrls.journal.remove(term)"
        ></search-dropdown>
      </div>
      <div class="col-md-3 text-center">
        <h5>Access</h5>
        <search-donut
          aggregation="$ctrl.filters.openAccess.aggregation"
          selected="$ctrl.filterCtrls.access.terms"
          on-add="$ctrl.filterCtrls.access.add(term)"
          on-remove="$ctrl.filterCtrls.access.remove(term)"
        ></search-donut>
        <a href class="small ph-link-icon"
          ng-click="$ctrl.filterCtrls.access.reset()"
          ng-class="{'ph-hidden': !$ctrl.filterCtrls.access.isActive()}"
        >
          <i class="fa fa-fw fa-times"></i>
          Clear filter
        </a>
        <search-dropdown
          description="Filter by access"
          aggregation="$ctrl.filters.openAccess.aggregation"
          selected="$ctrl.filterCtrls.access.terms"
          on-add="$ctrl.filterCtrls.access.add(term)"
          on-remove="$ctrl.filterCtrls.access.remove(term)"
        ></search-dropdown>
      </div>
    </div>
  </div>
</div>
<div class="container ph-md-padding-top ph-lg-margin-bottom">
  <p ng-if="$ctrl.documentsUpdating">
    <i class="fa fa-fw fa-circle-o-notch fa-spin"></i>
    Searching...
  </p>
  <p ng-if="$ctrl.searchTotal === 0">No documents match your query.</p>
  <p ng-if="$ctrl.searchTotal > 0">
    Found {{$ctrl.searchTotal | number}} documents.
  </p>
  <p class="small text-muted">
    Couldn't find what you are looking for? <a href ng-click="feedbackModal.open()">Send us feedback</a> with
    suggestions for content that you miss on PaperHive.
  </p>
  <div class="row ph-lg-margin-bottom row ph-md-margin-top">
    <div class="col-md-8">
      <div class="ph-lg-margin-top ph-fade-in ph-fade-out" ng-repeat="hit in $ctrl.searchHits">
        <h4>
          <a href="./documents/{{hit.documentItem.document}}" title="{{hit.documentItem.metadata.title}}">
            <mathjax body="hit.documentItem.metadata.title"></mathjax>
          </a>
        </h4>
        <span ng-repeat="author in hit.documentItem.metadata.authors">
          {{author.name}}{{$last ? '' : ', '}}
        </span>
        <small class="text-muted ph-sm-margin-left">
          {{hit.documentItem.metadata.publishedAt | date: 'yyyy'}}
        </small>
        <div class="ph-sm-margin-top">
          <small>
            <mathjax
              body="(hit.documentItem.metadata.abstract | limitTo: 220) + (hit.documentItem.metadata.abstract.length > 220 ? '&hellip;' : '')"
            ></mathjax>
          </small>
        </div>
      </div>
    </div>
  </div>
  <button ng-if="$ctrl.documents.length < $ctrl.searchTotal"
    ng-click="$ctrl.fetchDocumentsScroll()"
    ng-disabled="$ctrl.documentsScrollUpdating"
    class="btn btn-default" type="button"
  >
    <i ng-if="!$ctrl.documentsScrollUpdating" class="fa fa-fw fa-angle-double-down"></i>
    <i ng-if="$ctrl.documentsScrollUpdating" class="fa fa-fw fa-circle-o-notch fa-spin"></i>
    Load more
  </button>
</div>
